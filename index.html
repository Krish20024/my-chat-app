<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Chat App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        #chat-messages::-webkit-scrollbar,
        #online-users::-webkit-scrollbar {
            width: 8px;
        }

        #chat-messages::-webkit-scrollbar-track,
        #online-users::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }

        #chat-messages::-webkit-scrollbar-thumb,
        #online-users::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        #chat-messages::-webkit-scrollbar-thumb:hover,
        #online-users::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .delete-btn {
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .message-bubble:hover .delete-btn {
            opacity: 0.7;
        }

        .delete-btn:hover {
            opacity: 1;
        }
    </style>
</head>

<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <div id="app-container"
        class="w-full max-w-4xl h-[95vh] max-h-[900px] bg-white rounded-2xl shadow-2xl flex p-4 md:p-6">

        <!-- Welcome / Username Screen -->
        <div id="welcome-screen" class="flex flex-col items-center justify-center w-full text-center">
            <div class="bg-indigo-100 text-indigo-600 rounded-full p-4 mb-6">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
            </div>
            <h1 class="text-4xl font-bold text-slate-800 mb-2">Welcome to Chat!</h1>
            <p class="text-slate-500 mb-8">Enter your name and the secret code to join.</p>
            <form id="name-form" class="w-full max-w-sm flex flex-col items-center">
                <input type="text" id="username-input" placeholder="Your name..."
                    class="w-full px-4 py-3 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"
                    required>
                <input type="password" id="password-input" placeholder="Secret code..."
                    class="w-full mt-3 px-4 py-3 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"
                    required>
                <button type="submit"
                    class="mt-4 w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-300 ease-in-out shadow-lg">
                    Join Chat
                </button>
            </form>
            <p id="error-message" class="text-red-500 mt-4 h-6"></p>
        </div>

        
        <div id="chat-screen" class="hidden w-full flex h-full">
             
            <aside class="w-1/4 max-w-xs border-r border-slate-200 pr-4 flex flex-col">
                <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center">
                    <span class="relative flex h-3 w-3 mr-2">
                        <span
                            class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                    </span>
                    Online Users
                </h2>
                <div id="online-users" class="flex-1 overflow-y-auto">
                     
                </div>
            </aside>

             
            <div class="flex-1 flex flex-col pl-4">
                <header class="border-b border-slate-200 pb-4 mb-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="text-indigo-500" width="28" height="28"
                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                            <h1 class="text-2xl font-bold text-slate-800">Global Chat Room</h1>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-slate-500">Joined as:</span>
                            <span id="display-username" class="font-semibold text-indigo-600"></span>
                        </div>
                    </div>
                </header>

                <main id="chat-messages" class="flex-1 overflow-y-auto mb-2 p-4 bg-slate-50 rounded-lg space-y-4">
                    
                </main>

                <div id="typing-indicator" class="h-6 text-sm text-slate-500 italic px-4"></div>

                <footer class="mt-auto">
                    <form id="message-form" class="flex items-center space-x-4">
                        <input type="text" id="message-input" placeholder="Type a message..." autocomplete="off"
                            class="flex-1 px-4 py-3 bg-slate-100 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition"
                            required>
                        <button type="submit"
                            class="bg-indigo-600 text-white p-3 rounded-full hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-300 ease-in-out shadow-md">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="feather feather-send -rotate-12">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                        </button>
                    </form>
                </footer>
            </div>
        </div>
    </div>

    <footer class="mt-4 text-sm text-slate-500 text-center">
        <p>Created with ❤️ by <a href="https://github.com/your-username" target="_blank"
                class="font-semibold text-indigo-600 hover:underline">Krish</a></p>
    </footer>

    <audio id="notification-sound" src="https://freesound.org/data/previews/253/253887_3904323-lq.mp3"
        preload="auto"></audio>

    <!-- Firebase Libraries -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, setLogLevel, doc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { orderBy as firestoreOrderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getDatabase, ref, onValue, set, onDisconnect } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAFtxg7p6UfV0_Cs2kADnAcZlVovy5eZKM",
            authDomain: "chat-application-cbd8b.firebaseapp.com",
            projectId: "chat-application-cbd8b",
            storageBucket: "chat-application-cbd8b.firebasestorage.app",
            messagingSenderId: "403898227611",
            appId: "1:403898227611:web:0550f65a815664a8479f3e",
            measurementId: "G-63MC1570K2"
        };
        // ---------------------------------------------------------
        const appId = firebaseConfig.appId || 'default-app-id';

      
        if (!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY") {
            document.getElementById('welcome-screen').innerHTML = `
                <div class="text-center p-4 bg-red-100 text-red-700 rounded-lg">
                    <h2 class="font-bold text-xl mb-2">Configuration Missing!</h2>
                    <p>The Firebase configuration could not be loaded. Please paste it into the index.html file.</p>
                </div>`;
            throw new Error("Firebase config is not available.");
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);
        // setLogLevel('debug');

        let currentUser = null;
        let currentUsername = null;
        let typingTimeout;

        const messagesCollectionPath = `artifacts/${appId}/public/data/messages`;
        const typingCollectionPath = `artifacts/${appId}/public/data/typing`;
        const presencePath = `artifacts/${appId}/public/presence`;

        const welcomeScreen = document.getElementById('welcome-screen');
        const chatScreen = document.getElementById('chat-screen');
        const nameForm = document.getElementById('name-form');
        const usernameInput = document.getElementById('username-input');
        const displayUsername = document.getElementById('display-username');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const chatMessages = document.getElementById('chat-messages');
        const errorMessage = document.getElementById('error-message');
        const onlineUsersContainer = document.getElementById('online-users');
        const typingIndicator = document.getElementById('typing-indicator');
        const notificationSound = document.getElementById('notification-sound');

        async function login() {
            try {
                let userCredential;
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    userCredential = await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    userCredential = await signInAnonymously(auth);
                }
                currentUser = userCredential.user;
            } catch (error) {
                console.error("Authentication failed:", error);
                errorMessage.textContent = "Could not connect to the chat service.";
            }
        }

        function onUserLogin() {
            setupPresence();
            listenForMessages();
            listenForOnlineUsers();
            listenForTyping();
        }

        function listenForMessages() {
            const messagesRef = collection(db, messagesCollectionPath);
            const q = query(messagesRef, firestoreOrderBy("timestamp"));

            onSnapshot(q, (snapshot) => {
                chatMessages.innerHTML = '';
                snapshot.forEach((doc) => {
                    const message = doc.data();
                    const messageElement = createMessageElement(doc.id, message);
                    chatMessages.appendChild(messageElement);
                });

                if (snapshot.docChanges().some(change => change.type === 'added') && document.hidden) {
                    notificationSound.play().catch(e => console.log("Playback prevented"));
                }

                chatMessages.scrollTop = chatMessages.scrollHeight;
            });
        }

        function createMessageElement(id, message) {
            const isMyMessage = message.uid === currentUser.uid;
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex items-start gap-3 message-fade-in ${isMyMessage ? 'flex-row-reverse' : ''}`;

            const timestamp = message.timestamp ? message.timestamp.toDate() : new Date();

            messageWrapper.innerHTML = `
                <div class="flex flex-col message-bubble ${isMyMessage ? 'items-end' : 'items-start'}">
                    ${!isMyMessage ? `<div class="text-xs text-slate-500 ml-2 mb-1 font-medium">${message.username || 'Anonymous'}</div>` : ''}
                    <div class="relative max-w-xs md:max-w-md px-4 py-3 rounded-2xl shadow-sm ${isMyMessage ? 'bg-gradient-to-br from-indigo-500 to-violet-600 text-white rounded-br-none' : 'bg-white border border-slate-200 text-slate-800 rounded-bl-none'}">
                        <p class="break-words">${formatMessageText(message.text)}</p>
                        ${isMyMessage ? `<span class="delete-btn absolute top-1/2 -left-6 -translate-y-1/2" data-id="${id}" title="Delete message"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-400 hover:text-red-500"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></span>` : ''}
                    </div>
                    <div class="text-xs text-slate-400 mt-1 px-2">${formatTimestamp(timestamp)}</div>
                </div>
            `;

            const deleteBtn = messageWrapper.querySelector('.delete-btn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', () => {
                    const messageId = deleteBtn.getAttribute('data-id');
                    deleteMessage(messageId);
                });
            }
            return messageWrapper;
        }

        function formatMessageText(text) {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return text.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer" class="text-blue-300 underline hover:text-blue-200">$1</a>');
        }

        function formatTimestamp(date) {
            const now = new Date();
            const diff = now.getTime() - date.getTime();
            const diffDays = Math.floor(diff / (1000 * 3600 * 24));

            if (diffDays === 0) return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            if (diffDays === 1) return `Yesterday at ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
            return date.toLocaleDateString();
        }

        async function deleteMessage(messageId) {
            if (!messageId) return;
            const messageRef = doc(db, messagesCollectionPath, messageId);
            try {
                await deleteDoc(messageRef);
            } catch (error) {
                console.error("Error deleting message:", error);
            }
        }

        async function sendMessage(text) {
            if (!text.trim() || !currentUser) return;
            try {
                await addDoc(collection(db, messagesCollectionPath), {
                    text: text,
                    uid: currentUser.uid,
                    username: currentUsername,
                    timestamp: serverTimestamp()
                });
                messageInput.value = '';
                updateTypingStatus(false);
            } catch (error) {
                console.error("Error sending message: ", error);
            }
        }

        function setupPresence() {
            const myConnectionRef = ref(rtdb, `${presencePath}/${currentUser.uid}`);
            const connectedRef = ref(rtdb, '.info/connected');
            onValue(connectedRef, (snap) => {
                if (snap.val() === true) {
                    const con = set(myConnectionRef, { username: currentUsername, online: true });
                    onDisconnect(myConnectionRef).remove();
                }
            });
        }

        function listenForOnlineUsers() {
            const connectionsRef = ref(rtdb, presencePath);
            onValue(connectionsRef, (snapshot) => {
                const users = snapshot.val() || {};
                onlineUsersContainer.innerHTML = '';
                Object.values(users).forEach(user => {
                    const p = document.createElement('p');
                    p.className = 'text-slate-700 py-1';
                    p.textContent = user.username;
                    onlineUsersContainer.appendChild(p);
                });
            });
        }

        async function updateTypingStatus(isTyping) {
            const typingRef = doc(db, typingCollectionPath, currentUser.uid);
            try {
                if (isTyping) {
                    await setDoc(typingRef, { username: currentUsername });
                } else {
                    await deleteDoc(typingRef);
                }
            } catch (error) {
                console.error("Error updating typing status:", error);
            }
        }

        function listenForTyping() {
            const typingRef = collection(db, typingCollectionPath);
            onSnapshot(typingRef, (snapshot) => {
                const typers = snapshot.docs
                    .map(doc => doc.data().username)
                    .filter(name => name !== currentUsername);

                if (typers.length === 0) {
                    typingIndicator.textContent = '';
                } else if (typers.length === 1) {
                    typingIndicator.textContent = `${typers[0]} is typing...`;
                } else {
                    typingIndicator.textContent = `${typers.join(', ')} are typing...`;
                }
            });
        }

        nameForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = usernameInput.value.trim();
            const password = document.getElementById('password-input').value;
            const joinButton = e.target.querySelector('button');
            if (!username || !password) {
                errorMessage.textContent = "Please enter your name and the secret code.";
                return;
            }
            if (!currentUser) {
                errorMessage.textContent = "Connecting... Please try again in a moment.";
                return;
            }

            joinButton.disabled = true;
            joinButton.textContent = 'Verifying...';
            errorMessage.textContent = '';

            try {
                const secretDocRef = doc(db, `artifacts/${appId}/public/data/config`, 'secret');
                const docSnap = await getDoc(secretDocRef);
                if (docSnap.exists() && password === docSnap.data().code) {
                    currentUsername = username;
                    displayUsername.textContent = currentUsername;
                    welcomeScreen.classList.add('hidden');
                    chatScreen.classList.remove('hidden');
                    onUserLogin();
                } else {
                    errorMessage.textContent = "Incorrect secret code. Please try again.";
                }
            } catch (error) {
                console.error("Error verifying secret code:", error);
                errorMessage.textContent = "Could not verify secret code. Try again.";
            } finally {
                joinButton.disabled = false;
                joinButton.textContent = 'Join Chat';
            }
        });

        messageForm.addEventListener('submit', (e) => {
            e.preventDefault();
            sendMessage(messageInput.value);
        });

        messageInput.addEventListener('input', () => {
            clearTimeout(typingTimeout);
            updateTypingStatus(true);
            typingTimeout = setTimeout(() => {
                updateTypingStatus(false);
            }, 2000);
        });

        login();
    </script>
</body>

</html>
